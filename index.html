<!DOCTYPE html>
<html lang="en">

<head>
    <title>GP Initializer</title>

    <script id="build.gradle" type="text/x-dot-template">
group '{{=it.packageName}}'
version '{{=it.version}}'
	</script>

    <script id="settings.gradle" type="text/x-dot-template">
rootProject.name = '{{=it.name}}'
include '{{=it.name}}-package'
include '{{=it.name}}-app'
	</script>

    <script id="package/build.gradle" type="text/x-dot-template">
buildscript {
    repositories {
        mavenLocal()
        jcenter()
        gradlePluginPortal()
    }
    dependencies {
        classpath 'io.graphoenix:graphoenix-gradle-plugin:0.0.1-SNAPSHOT'
    }
}

plugins {
    id 'java'
    {{?it.grpc}}id 'com.google.protobuf' version '0.9.1'{{?}}
}
apply plugin: 'io.graphoenix'

{{?it.grpc}}protobuf {
    protoc {
        artifact = 'com.google.protobuf:protoc:3.21.7'
    }
    plugins {
        grpc {
            artifact = 'io.grpc:protoc-gen-grpc-java:1.52.1'
        }
        reactor {
            artifact = 'com.salesforce.servicelibs:reactor-grpc:1.2.3'
        }
        doc {
            artifact = 'io.github.pseudomuto:protoc-gen-doc:1.5.1'
        }
    }
    generateProtoTasks {
        all()*.plugins {
            grpc {}
            reactor {}
            doc {
                option 'markdown,grpc-docs.md'
            }
        }
    }
}

sourceSets {
    main {
        java {
            srcDirs 'build/generated/source/proto/main/java'
            srcDirs 'build/generated/source/proto/main/grpc'
            srcDirs 'build/generated/source/proto/main/reactor'
            srcDirs 'build/generated/source/proto/main/doc'
        }
    }
}{{?}}

group '{{=it.packageName}}'
version '{{=it.version}}'

repositories {
    mavenCentral()
    jcenter()
    mavenLocal()
}

dependencies {
    implementation 'io.graphoenix:graphoenix-core:0.0.1-SNAPSHOT'
    implementation 'io.nozdormu:nozdormu-inject:0.0.1-SNAPSHOT'
    implementation 'io.nozdormu:nozdormu-async:0.0.1-SNAPSHOT'
    implementation 'io.nozdormu:nozdormu-interceptor:0.0.1-SNAPSHOT'
    implementation 'io.nozdormu:nozdormu-config:0.0.1-SNAPSHOT'
    {{?it.grpc}}runtimeOnly 'io.grpc:grpc-netty-shaded:1.52.1'
    implementation 'io.grpc:grpc-protobuf:1.52.1'
    implementation 'io.grpc:grpc-stub:1.52.1'
    implementation 'com.salesforce.servicelibs:reactor-grpc-stub:1.2.3'

    compileOnly 'org.apache.tomcat:annotations-api:6.0.53' // necessary for Java 9+{{?}}

    annotationProcessor 'io.graphoenix:graphoenix-annotation-processor:0.0.1-SNAPSHOT'
    annotationProcessor 'io.nozdormu:nozdormu-inject:0.0.1-SNAPSHOT'
    annotationProcessor 'io.nozdormu:nozdormu-async:0.0.1-SNAPSHOT'
    annotationProcessor 'io.nozdormu:nozdormu-interceptor:0.0.1-SNAPSHOT'
    annotationProcessor 'io.nozdormu:nozdormu-config:0.0.1-SNAPSHOT'

    {{?it.grpc}}protobuf 'io.graphoenix:graphoenix-core:0.0.1-SNAPSHOT'{{?}}

    testImplementation platform('org.junit:junit-bom:5.9.1')
    testImplementation 'org.junit.jupiter:junit-jupiter'
}

test {
    useJUnitPlatform()
}
    </script>

    <script id="package-info.java" type="text/x-dot-template">
@Package
package {{=it.packageName}};

import io.graphoenix.spi.annotation.Package;
    </script>

    <script id=".gql" type="text/x-dot-template">
    </script>

    <script id="app/build.gradle" type="text/x-dot-template">
plugins {
    id 'java'
}

group '{{=it.packageName}}'
version '{{=it.version}}'

repositories {
    mavenCentral()
    jcenter()
    mavenLocal()
}

dependencies {
    implementation project(':{{=it.name}}-package')
    implementation 'io.graphoenix:graphoenix-core:0.0.1-SNAPSHOT'
    {{?it.mysql}}implementation 'io.graphoenix:graphoenix-r2dbc:0.0.1-SNAPSHOT'{{?}}
    {{?it.http}}implementation 'io.graphoenix:graphoenix-http-server:0.0.1-SNAPSHOT'
    //implementation group: 'io.netty', name: 'netty-resolver-dns-native-macos', version: '4.1.75.Final', classifier: 'osx-aarch_64'{{?}}
    {{?it.grpc}}implementation 'io.graphoenix:graphoenix-grpc-server:0.0.1-SNAPSHOT'{{?}}
    {{?it.rabbitmq}}implementation 'io.graphoenix:graphoenix-rabbitmq:0.0.1-SNAPSHOT'{{?}}
    {{?it.gossip}}implementation 'io.graphoenix:graphoenix-gossip:0.0.1-SNAPSHOT'{{?}}
    {{?it.jsonSchema}}implementation 'io.graphoenix:graphoenix-json-schema:0.0.1-SNAPSHOT'{{?}}
    {{?it.introspection}}implementation 'io.graphoenix:graphoenix-introspection:0.0.1-SNAPSHOT'{{?}}
    {{?it.admin}}implementation 'io.graphoenix:graphoenix-admin:0.0.1-SNAPSHOT'{{?}}

    implementation 'io.nozdormu:nozdormu-inject:0.0.1-SNAPSHOT'
    implementation 'io.nozdormu:nozdormu-async:0.0.1-SNAPSHOT'
    implementation 'io.nozdormu:nozdormu-interceptor:0.0.1-SNAPSHOT'
    implementation 'io.nozdormu:nozdormu-config:0.0.1-SNAPSHOT'
    {{?it.mysql}}implementation 'org.mariadb:r2dbc-mariadb:1.1.4'{{?}}

    annotationProcessor project(':{{=it.name}}-package')
    annotationProcessor 'io.graphoenix:graphoenix-annotation-processor:0.0.1-SNAPSHOT'
    {{?it.mysql}}annotationProcessor 'io.graphoenix:graphoenix-sql:0.0.1-SNAPSHOT'{{?}}
    {{?it.grpc}}annotationProcessor 'io.graphoenix:graphoenix-grpc-server:0.0.1-SNAPSHOT'{{?}}
    {{?it.gossip}}annotationProcessor 'io.graphoenix:graphoenix-gossip:0.0.1-SNAPSHOT'{{?}}
    {{?it.jsonSchema}}annotationProcessor 'io.graphoenix:graphoenix-json-schema:0.0.1-SNAPSHOT'{{?}}
    {{?it.introspection}}annotationProcessor 'io.graphoenix:graphoenix-introspection:0.0.1-SNAPSHOT'{{?}}

    testImplementation 'org.junit.jupiter:junit-jupiter-api:5.7.0'
    testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine:5.7.0'
}

test {
    useJUnitPlatform()
}
	</script>

    <script id="App.java" type="text/x-dot-template">
package {{=it.packageName}};
import io.graphoenix.spi.annotation.Application;

import static io.graphoenix.core.bootstrap.App.APP;

@Application
public class App {

    public static void main(String[] args) {
        APP.run(args);
    }
}
    </script>

    <script id="application.conf" type="text/x-dot-template">
graphql {
  buildIntrospection = true
}
package {
  packageName = "{{=it.packageName}}"
  localPackageNames = [{{?it.jsonSchema}}"io.graphoenix.jsonschema",{{?}} {{?it.introspection}}"io.graphoenix.introspection",{{?}}]
}
{{?it.mysql}}r2dbc {
  driver = "mariadb"
  database = "user"
  user = "root"
  password = "root"
}{{?}}
{{?it.rabbitmq}}rabbitmq {
  username = "guest"
  password = "guest"
}{{?}}
{{?it.gossip}}gossip {
  port = 9090
}{{?}}
    </script>

    <script src="js/doT.min.js" type="text/javascript"></script>
    <script src="js/jszip.min.js" type="text/javascript"></script>
    <script src="js/jszip-utils.min.js" type="text/javascript"></script>
    <script src="js/FileSaver.min.js" type="text/javascript"></script>
</head>

<body>
    <main>
        <h3>Graphoenix Server Initializer</h3>
        <p>
            <label for="name">name:</label>
            <br />
            <input id="name" placeholder="your-project-name" type="text">
        </p>
        <p>
            <label for="packageName">package name:</label>
            <br />
            <input id="packageName" placeholder="your.package.name" type="text">
        </p>
        <p>
            <label for="version">version:</label>
            <br />
            <input id="version" type="text" placeholder="0.0.1-SNAPSHOT" value="0.0.1-SNAPSHOT">
        </p>
        <p>
            <label for="gradle">build tool:</label>
            <br />
            <input type="radio" id="gradle" name="buildTool" value="gradle" checked>gradle
            <input type="radio" name="buildTool" value="maven" disabled>maven
        </p>
        <p>
            <label for="grpc">protocol:</label>
            <br />
            <input type="checkbox" id="grpc" value="grpc" checked>grpc
            <input type="checkbox" id="http" value="http" checked>http
            <input type="checkbox" id="rsocket" value="rsocket" disabled>rsocket
        </p>
        <p>
            <label for="mysql">database:</label>
            <br />
            <input type="checkbox" id="mysql" value="mysql" checked>mysql
            <input type="checkbox" id="postgresql" value="postgresql" disabled>postgresql
            <input type="checkbox" id="mongodb" value="mongodb" disabled>mongodb
            <input type="checkbox" id="redis" value="redis" disabled>redis
        </p>
        <p>
            <label for="rabbitmq">mq:</label>
            <br />
            <input type="checkbox" id="rabbitmq" value="rabbitmq" checked>rabbitmq
            <input type="checkbox" id="kafka" value="kafka" disabled>kafka
        </p>
        <p>
            <label for="gossip">cluster:</label>
            <br />
            <input type="checkbox" id="gossip" value="gossip" checked>gossip
            <input type="checkbox" id="registry" value="registry" disabled>registry
        </p>
        <p>
            <label for="introspection">others:</label>
            <br />
            <input type="checkbox" id="introspection" value="introspection" checked>introspection
            <input type="checkbox" id="jsonSchema" value="jsonSchema" checked>json-schema
            <input type="checkbox" id="admin" value="admin" checked>admin ui
        </p>
        <p>
            <button onclick="generate()">generate</button>
        </p>
        <p>
            <label for="introspection">ui:</label>
            <br />
            <a href="/svelte">svelte</a>
            <del>vue</del>
            <del>react</del>
        </p>
    </main>
</body>

<script type="text/javascript">
    var data;

    function generate() {
        var name = document.getElementById('name').value;
        var packageName = document.getElementById('packageName').value;
        var version = document.getElementById('version').value;

        if (!name) {
            alert('name is required');
            document.getElementById('name').focus();
            return;
        }

        if (!packageName) {
            alert('packageName is required');
            document.getElementById('packageName').focus();
            return;
        }

        if (!version) {
            alert('version is required');
            document.getElementById('version').focus();
            return;
        }

        var buildTool = document.querySelector('input[name="buildTool"]:checked').value;
        var grpc = document.getElementById('grpc').checked;
        var http = document.getElementById('http').checked;
        var rsocket = document.getElementById('rsocket').checked;
        var mysql = document.getElementById('mysql').checked;
        var postgresql = document.getElementById('postgresql').checked;
        var mongodb = document.getElementById('mongodb').checked;
        var redis = document.getElementById('redis').checked;
        var rabbitmq = document.getElementById('rabbitmq').checked;
        var kafka = document.getElementById('kafka').checked;
        var gossip = document.getElementById('gossip').checked;
        var registry = document.getElementById('registry').checked;
        var introspection = document.getElementById('introspection').checked;
        var jsonSchema = document.getElementById('jsonSchema').checked;
        var admin = document.getElementById('admin').checked;

        data = {
            name: name,
            packageName: packageName,
            version: version,
            buildTool: buildTool,
            grpc: grpc,
            http: http,
            rsocket: rsocket,
            mysql: mysql,
            postgresql: postgresql,
            mongodb: mongodb,
            redis: redis,
            rabbitmq: rabbitmq,
            kafka: kafka,
            gossip: gossip,
            registry: registry,
            introspection: introspection,
            jsonSchema: jsonSchema,
            admin: admin
        }

        var promise = new JSZip.external.Promise(function (resolve, reject) {
            JSZipUtils.getBinaryContent('static.zip', function (err, data) {
                if (err) {
                    reject(err);
                } else {
                    resolve(data);
                }
            });
        });

        promise.then(JSZip.loadAsync)
            .then(function(zip) {
                zip.file('build.gradle', build('build.gradle'));
                zip.file('settings.gradle', build('settings.gradle'));

                var package = zip.folder(name + '-package');
                package.file('build.gradle', build('package/build.gradle'));

                var package_java = zip.folder(name + '-package/src/main/java/' + packageName.split('.').join('/'));
                package_java.file('package-info.java', build('package-info.java'));

                var package_resources_graphql = zip.folder(name + '-package/src/main/resources/graphql');
                package_resources_graphql.file(name + '.gql', build('.gql'));

                var app = zip.folder(name + '-app');
                app.file('build.gradle', build('app/build.gradle'));

                var app_java = zip.folder(name + '-app/src/main/java/' + packageName.split('.').join('/'));
                app_java.file('App.java', build('App.java'));

                var app_resources = zip.folder(name + '-app/src/main/resources');
                app_resources.file('application.conf', build('application.conf'));

                zip.generateAsync({ type: 'blob' })
                    .then(function (content) {
                        saveAs(content, name + '.zip');
                    });
            });
    }

    function build(templateName) {
        var template = doT.template(encode(document.getElementById(templateName).text), undefined, {});
        return decode(template(data));
    }

    function encode(text) {
        return text.split('\n').filter((currentValue, index) => index !== 0 || currentValue).join('\\n');
    }

    function decode(text) {
        return text.split('\\n').join('\n');
    }
</script>

</html>